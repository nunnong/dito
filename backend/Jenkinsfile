pipeline {
    agent any

    environment {
        // Docker ì´ë¯¸ì§€ ì •ë³´
        DOCKER_IMAGE = "dito-backend"
        DOCKER_TAG = "${env.BUILD_NUMBER}"
        DOCKER_REGISTRY = "localhost:5000" // í•„ìš”ì‹œ Docker Registry ì£¼ì†Œë¡œ ë³€ê²½

        // í”„ë¡œì íŠ¸ ê²½ë¡œ
        BACKEND_DIR = "backend"

        // Docker Compose íŒŒì¼ ê²½ë¡œ
        COMPOSE_FILE = "${BACKEND_DIR}/docker-compose.yml"

        // GitLab Webhook Secret (Jenkinsì— Secret textë¡œ ë“±ë¡: gitlab-webhook-secret)
        GITLAB_WEBHOOK_SECRET = credentials('gitlab-webhook-secret')

        // NOTE: Do NOT use `environment { ENV_FILE = credentials('...') }` for secret file injection.
        // Secret files should be injected at runtime with withCredentials(file(...)).
    }

    options {
        // ë¹Œë“œ ë³´ê´€ ì •ì±…
        buildDiscarder(logRotator(numToKeepStr: '10', artifactNumToKeepStr: '10'))

        // íƒ€ì„ì•„ì›ƒ ì„¤ì •
        timeout(time: 30, unit: 'MINUTES')

        // ë™ì‹œ ë¹Œë“œ ë°©ì§€
        disableConcurrentBuilds()

        // íƒ€ì„ìŠ¤íƒ¬í”„ ì¶œë ¥
        timestamps()
    }

    triggers {
        // GitLab Webhook íŠ¸ë¦¬ê±° (backend ë¸Œëœì¹˜)
        gitlab(
            triggerOnPush: true,
            triggerOnMergeRequest: true,
            branchFilterType: 'NameBasedFilter',
            includeBranchesSpec: 'backend',
            secretToken: env.GITLAB_WEBHOOK_SECRET
        )
    }

    stages {
        stage('ğŸ“‹ Prepare') {
            steps {
                script {
                    echo "========================================="
                    echo "ğŸš€ Starting CI/CD Pipeline"
                    echo "========================================="
                    echo "Build Number: ${env.BUILD_NUMBER}"
                    echo "Branch: ${env.GIT_BRANCH}"
                    echo "Commit: ${env.GIT_COMMIT}"
                    echo "========================================="
                }

                // ì‘ì—… ë””ë ‰í† ë¦¬ ì •ë¦¬
                sh "echo 'ğŸ§¹ Cleaning workspace...'"
            }
        }

        stage('ğŸ” Checkout') {
            steps {
                echo "ğŸ“¦ Checking out source code..."
                checkout scm

                script {
                    // Git ì •ë³´ í™•ì¸
                    sh """
                        echo "Current directory: \$(pwd)"
                        echo "Git branch: \$(git rev-parse --abbrev-ref HEAD)"
                        echo "Git commit: \$(git rev-parse --short HEAD)"
                    """
                }
            }
        }

        stage('ğŸ” Environment Setup') {
            steps {
                echo "ğŸ” Setting up environment variables..."
                script {
                    // Jenkins Secret file (credentials kind: Secret file, id: dito-backend-env)
                    // ì•ˆì „í•˜ê²Œ íŒŒì¼ì„ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ì— ë³µì‚¬í•©ë‹ˆë‹¤.
                    withCredentials([file(credentialsId: 'dito-backend-env', variable: 'ENV_FILE')]) {
                        sh "cp $ENV_FILE ${BACKEND_DIR}/.env && chmod 600 ${BACKEND_DIR}/.env"
                        echo "âœ… Environment file copied successfully"
                        echo "Environment variables loaded (secrets hidden)"
                    }
                }
            }
        }

        stage('ğŸ—ï¸ Build Docker Image') {
            steps {
                echo "ğŸ—ï¸ Building Docker image (Multi-stage build for optimization)..."
                script {
                    dir("${BACKEND_DIR}") {
                        sh """
                            echo "Building image: ${DOCKER_REGISTRY}/${DOCKER_IMAGE}:${DOCKER_TAG}"

                            # Docker ì´ë¯¸ì§€ ë¹Œë“œ (ê²½ëŸ‰í™”ëœ ë©€í‹°ìŠ¤í…Œì´ì§€ ë¹Œë“œ)
                            docker build \
                                --tag ${DOCKER_REGISTRY}/${DOCKER_IMAGE}:${DOCKER_TAG} \
                                --tag ${DOCKER_REGISTRY}/${DOCKER_IMAGE}:latest \
                                --build-arg BUILD_DATE=\$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
                                --build-arg VCS_REF=\$(git rev-parse --short HEAD) \
                                --no-cache \
                                -f Dockerfile \
                                .

                            echo "âœ… Docker image built successfully"
                            docker images | grep ${DOCKER_IMAGE}
                        """
                    }
                }
            }
        }

        stage('ğŸ§ª Image Verification') {
            steps {
                echo "ğŸ§ª Verifying Docker image..."
                script {
                    sh """
                        echo "Image size and details:"
                        docker images ${DOCKER_IMAGE}:${DOCKER_TAG}

                        echo "Image layers:"
                        docker history ${DOCKER_IMAGE}:${DOCKER_TAG} --no-trunc
                    """
                }
            }
        }

        stage('ğŸ”„ Stop Old Containers') {
            steps {
                echo "ğŸ”„ Stopping and removing old containers..."
                script {
                    dir("${BACKEND_DIR}") {
                        sh """
                            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì œê±° (ì—ëŸ¬ ë¬´ì‹œ)
                            docker-compose -f docker-compose.yml down || true

                            echo "âœ… Old containers stopped"
                        """
                    }
                }
            }
        }

        stage('ğŸš€ Deploy') {
            steps {
                echo "ğŸš€ Deploying application with Docker Compose..."
                script {
                    dir("${BACKEND_DIR}") {
                        sh """
                            # Docker Composeë¡œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘
                            docker-compose -f docker-compose.yml up -d

                            echo "â³ Waiting for services to be healthy..."
                            sleep 10

                            # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
                            docker-compose -f docker-compose.yml ps

                            echo "âœ… Deployment completed"
                        """
                    }
                }
            }
        }

        stage('ğŸ¥ Health Check') {
            steps {
                echo "ğŸ¥ Performing health check..."
                script {
                    retry(5) {
                        sleep 10
                        sh """
                            # í—¬ìŠ¤ì²´í¬ ì—”ë“œí¬ì¸íŠ¸ í™•ì¸
                            curl -f http://localhost:8080/actuator/health || exit 1
                            echo "âœ… Application is healthy"
                        """
                    }
                }
            }
        }

        stage('ğŸ§¹ Cleanup') {
            steps {
                echo "ğŸ§¹ Cleaning up old Docker images..."
                script {
                    sh """
                        # ì˜¤ë˜ëœ ì´ë¯¸ì§€ ì •ë¦¬ (ìµœê·¼ 3ê°œ ì œì™¸)
                        docker images ${DOCKER_IMAGE} --format "{{.ID}} {{.Tag}}" | \
                        grep -v latest | \
                        tail -n +4 | \
                        awk '{print \$1}' | \
                        xargs -r docker rmi -f || true

                        # dangling ì´ë¯¸ì§€ ì œê±°
                        docker image prune -f

                        echo "âœ… Cleanup completed"
                    """
                }
            }
        }
    }

    post {
        success {
            echo "========================================="
            echo "âœ… CI/CD Pipeline completed successfully!"
            echo "========================================="
            script {
                // GitLabì— ì„±ê³µ ìƒíƒœ ì „ì†¡
                updateGitlabCommitStatus name: 'build', state: 'success'

                // ë°°í¬ ì •ë³´ ì¶œë ¥
                sh """
                    echo "ğŸ‰ Deployment Information:"
                    echo "  - Image: ${DOCKER_IMAGE}:${DOCKER_TAG}"
                    echo "  - Build: #${env.BUILD_NUMBER}"
                    echo "  - Time: \$(date)"
                    docker-compose -f ${COMPOSE_FILE} ps
                """
            }
        }

        failure {
            echo "========================================="
            echo "âŒ CI/CD Pipeline failed!"
            echo "========================================="
            script {
                // GitLabì— ì‹¤íŒ¨ ìƒíƒœ ì „ì†¡
                updateGitlabCommitStatus name: 'build', state: 'failed'

                // ë¡œê·¸ ìˆ˜ì§‘
                sh """
                    echo "ğŸ“‹ Container logs:"
                    docker-compose -f ${COMPOSE_FILE} logs --tail=100 || true
                """
            }
        }

        always {
            echo "ğŸ” Pipeline execution completed"
            script {
                // í™˜ê²½ íŒŒì¼ ì‚­ì œ (ë³´ì•ˆ)
                sh """
                    rm -f ${BACKEND_DIR}/.env || true
                    echo "ğŸ” Sensitive files cleaned up"
                """
            }
        }
    }
}
