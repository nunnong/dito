pipeline {
  agent any

  environment {
    // ====== ê¸°ë³¸ ì„¤ì • ======
    BACKEND_DIR     = 'backend'
    COMPOSE_FILE    = "${env.BACKEND_DIR}/docker-compose.yml"
    DOCKER_IMAGE    = 'dito-backend:latest'                            // ê³ ì • íƒœê·¸ (ì´ë¯¸ì§€ ì¬ì‚¬ìš©)
  }

  options {
    buildDiscarder(logRotator(numToKeepStr: '10'))
    timeout(time: 30, unit: 'MINUTES')
    disableConcurrentBuilds()
    timestamps()
  }

  stages {

    stage('ğŸ“‹ Prepare') {
      steps {
        script {
          echo '========================================='
          echo "ğŸš€ Starting CI/CD Pipeline"
          echo "Build #${env.BUILD_NUMBER}"
          echo "Branch: ${env.GIT_BRANCH ?: 'N/A'}"
          echo '========================================='
        }
        deleteDir()
      }
    }

    stage('ğŸ” Checkout') {
      steps {
        echo "ğŸ“¦ Checking out source from SCM..."
        checkout scm
        sh '''
          echo "Current directory: $(pwd)"
          echo "Git branch: $(git rev-parse --abbrev-ref HEAD)"
          echo "Git commit: $(git rev-parse --short HEAD)"
        '''
      }
    }

    stage('ğŸ” Environment Setup') {
      steps {
        echo 'ğŸ” Injecting secret env file...'
        script {
          withCredentials([file(credentialsId: 'dito-backend-env', variable: 'ENV_FILE')]) {
            sh '''
              cp "$ENV_FILE" "$BACKEND_DIR/.env"
              chmod 600 "$BACKEND_DIR/.env"
            '''
          }
        }
      }
    }

    stage('ğŸ—ï¸ Build JAR') {
      steps {
        dir("${BACKEND_DIR}/Dito") {  // gradlewê°€ ìˆëŠ” ê²½ë¡œë¡œ ì´ë™
          sh '''
            echo "ğŸ§± Building jar file..."
            chmod +x gradlew
            ./gradlew clean build -x test
          '''
        }
    }

    stage('ğŸš€ Deploy (Local Docker)') {
      steps {
        dir("${BACKEND_DIR}") {
          sh '''#!/bin/bash -e
            echo "ğŸ§¹ Stopping existing containers..."
            docker-compose -f docker-compose.yml down || true

            echo "ğŸ” Built artifacts:"
            ls -al Dito/build/libs || true

            echo "ğŸ“¦ Picking Spring Boot fat jar (exclude *-plain.jar)..."
            # -plain.jar ì œì™¸í•˜ê³  ì²« ë²ˆì§¸ í•­ëª©ë§Œ ì„ íƒ (ë°±ìŠ¬ë˜ì‹œ ì´ìŠ¤ì¼€ì´í”„ ì—†ì´ ë¦¬í„°ëŸ´ ë§¤ì¹­)
            JAR_PATH=$(ls Dito/build/libs/*-SNAPSHOT.jar | grep -v -- "-plain.jar" | head -n1)

            if [ -z "$JAR_PATH" ] || [ ! -f "$JAR_PATH" ]; then
              echo "âŒ Boot JAR not found in Dito/build/libs (fat jar)"
              exit 1
            fi

            echo "â¡ï¸  Copying $JAR_PATH -> app.jar"
            cp "$JAR_PATH" ./app.jar
            chmod 644 ./app.jar

            echo "ğŸš€ Docker Compose build & up..."
            docker compose -f docker-compose.yml up -d --build

            echo "âœ… Current services:"
            docker compose -f docker-compose.yml ps
          '''
        }
      }
    }



    stage('ğŸ¥ Health Check') {
      steps {
        script {
          // ìµœëŒ€ 10ë²ˆ, 10ì´ˆ ê°„ê²©ìœ¼ë¡œ ì¬ì‹œë„
          retry(10) {
            sh '''
              set -e

              APP_PORT="${APP_PORT:-8080}"
              URL="http://localhost:${APP_PORT}/actuator/health"

              # ìƒíƒœì½”ë“œë§Œ ì¶”ì¶œ (ì—ëŸ¬ì—¬ë„ ì¢…ë£Œí•˜ì§€ ì•Šë„ë¡ || true)
              CODE=$(curl -s -o /dev/null -w "%{http_code}" "$URL" || true)

              if [ "$CODE" = "200" ] || [ "$CODE" = "403" ]; then
                echo "âœ… Health check passed with HTTP $CODE"
                exit 0
              else
                echo "â³ Health not ready yet (HTTP $CODE). Retrying..."
                sleep 10
                exit 1
              fi
            '''
          }
        }
      }
    }


    stage('ğŸ§¹ Cleanup') {
      steps {
        sh '''
          echo "ğŸ§¹ Cleaning up unused images..."
          docker image prune -f || true
        '''
      }
    }
  }

  post {
    success {
      echo '========================================='
      echo "âœ… CI/CD Pipeline completed successfully!"
      echo '========================================='
      sh '''
        echo "ğŸ‰ Deployment Info"
        echo "  Image: ${DOCKER_IMAGE}"
        echo "  Build: #${BUILD_NUMBER}"
        echo "  Time : $(date)"
      '''
    }
    failure {
      echo '========================================='
      echo "âŒ CI/CD Pipeline failed!"
      echo '========================================='
      sh "docker compose -f ${COMPOSE_FILE} logs --tail=100 || true"
    }
    always {
      echo 'ğŸ” Finalizing...'
      sh "rm -f ${BACKEND_DIR}/.env || true"
    }
  }
}
