pipeline {
  agent any

  // â–¶ ì›¹í›…ìœ¼ë¡œ ì „ë‹¬ë°›ì„ ë¸Œëœì¹˜
  parameters {
    string(name: 'BRANCH', defaultValue: 'infra', description: 'ë¹Œë“œí•  Git ë¸Œëœì¹˜')
  }

  environment {
    // ====== ë¹Œë“œ/ë°°í¬ ê³µí†µ ======
    GIT_URL          = 'https://lab.ssafy.com/s13-final/S13P31A708.git' // ë ˆí¬ URL (HTTPS ê¶Œì¥)
    GIT_CREDENTIALS  = 'gitlab-https-pat'  // Jenkins í¬ë¦¬ë´ì…œ ID(Username+Password=PAT)

    BACKEND_DIR      = 'backend'
    COMPOSE_FILE     = "${env.BACKEND_DIR}/docker-compose.yml"

    DOCKER_IMAGE     = 'dito-backend'
    DOCKER_REGISTRY  = 'localhost:5000'    // í•„ìš” ì‹œ ì‚¬ì„¤/ê³µì‹ ë ˆì§€ìŠ¤íŠ¸ë¦¬ë¡œ êµì²´
    DOCKER_TAG       = "${env.BUILD_NUMBER}"
  }

  options {
    buildDiscarder(logRotator(numToKeepStr: '10', artifactNumToKeepStr: '10'))
    timeout(time: 30, unit: 'MINUTES')
    disableConcurrentBuilds()
    timestamps()
  }

  // NOTE: íŠ¸ë¦¬ê±°ëŠ” Jenkins UIì˜ "Trigger builds remotely" + GitLab Webhook(/buildWithParameters)ë§Œ ì‚¬ìš©.
  // Jenkinsfileì˜ triggers{} ë¸”ë¡ì€ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ(ì¶©ëŒ ë°©ì§€).

  stages {

    stage('ğŸ“‹ Prepare') {
      steps {
        script {
          echo '========================================='
          echo "ğŸš€ Starting CI/CD Pipeline"
          echo "Build #${env.BUILD_NUMBER}"
          echo "Branch param: ${params.BRANCH}"
          echo '========================================='
        }
        // ê¹¨ë—í•œ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ì—ì„œ ì‹œì‘(ì„ íƒ)
        deleteDir()
      }
    }

    stage('ğŸ” Checkout') {
      steps {
        echo "ğŸ“¦ Checking out source from ${params.BRANCH}..."
        git branch: params.BRANCH, url: env.GIT_URL, credentialsId: env.GIT_CREDENTIALS
        sh '''
          echo "Current directory: $(pwd)"
          echo "Git branch: $(git rev-parse --abbrev-ref HEAD)"
          echo "Git commit: $(git rev-parse --short HEAD)"
        '''
      }
    }

    stage('ğŸ” Environment Setup') {
      steps {
        echo 'ğŸ” Injecting secret env file...'
        script {
          // Jenkins Credentials: Secret file (ID: dito-backend-env)
          withCredentials([file(credentialsId: 'dito-backend-env', variable: 'ENV_FILE')]) {
            sh """
              cp "$ENV_FILE" "${BACKEND_DIR}/.env"
              chmod 600 "${BACKEND_DIR}/.env"
            """
          }
        }
      }
    }

    stage('ğŸ—ï¸ Build Docker Image') {
      steps {
        echo "ğŸ—ï¸ Building Docker image ${DOCKER_REGISTRY}/${DOCKER_IMAGE}:${DOCKER_TAG}"
        dir("${BACKEND_DIR}") {
          sh """
            docker build \
              -t ${DOCKER_REGISTRY}/${DOCKER_IMAGE}:${DOCKER_TAG} \
              -t ${DOCKER_REGISTRY}/${DOCKER_IMAGE}:latest \
              --build-arg BUILD_DATE="$(date -u +'%Y-%m-%dT%H:%M:%SZ')" \
              --build-arg VCS_REF="$(git rev-parse --short HEAD)" \
              -f Dockerfile .
            docker images | grep ${DOCKER_IMAGE} || true
          """
        }
      }
    }

    stage('ğŸ§ª Image Verification') {
      steps {
        sh """
          echo "Image details:"
          docker images ${DOCKER_REGISTRY}/${DOCKER_IMAGE}:${DOCKER_TAG} || true
          echo "Layers:"
          docker history ${DOCKER_REGISTRY}/${DOCKER_IMAGE}:${DOCKER_TAG} --no-trunc || true
        """
      }
    }

    stage('ğŸ”„ Stop Old Containers') {
      steps {
        dir("${BACKEND_DIR}") {
          sh 'docker-compose -f docker-compose.yml down || true'
        }
      }
    }

    stage('ğŸš€ Deploy') {
      steps {
        dir("${BACKEND_DIR}") {
          sh """
            # í•„ìš” ì‹œ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ë¡œê·¸ì¸(ì‚¬ì„¤/ë³´ì•ˆ ë ˆì§€ìŠ¤íŠ¸ë¦¬ì¼ ë•Œë§Œ)
            # echo "$DOCKER_PASSWORD" | docker login ${DOCKER_REGISTRY} -u "$DOCKER_USERNAME" --password-stdin

            docker-compose -f docker-compose.yml up -d
            echo "â³ Waiting for services..."
            sleep 10
            docker-compose -f docker-compose.yml ps
          """
        }
      }
    }

    stage('ğŸ¥ Health Check') {
      steps {
        script {
          retry(5) {
            sleep 10
            sh 'curl -fsS http://localhost:8080/actuator/health && echo "âœ… Healthy"'
          }
        }
      }
    }

    stage('ğŸ§¹ Cleanup') {
      steps {
        sh """
          # ìµœê·¼ 3ê°œ íƒœê·¸ë§Œ ë‚¨ê¸°ê³  ë¡œì»¬ ì´ë¯¸ì§€ ì •ë¦¬ (latest ì œì™¸)
          docker images ${DOCKER_REGISTRY}/${DOCKER_IMAGE} --format '{{.ID}} {{.Tag}}' | \
          grep -v latest | awk '{print $1" "$2}' | sort -k2 -rn | awk 'NR>3{print $1}' | \
          xargs -r docker rmi -f || true

          docker image prune -f || true
        """
      }
    }
  }

  post {
    success {
      echo '========================================='
      echo "âœ… CI/CD Pipeline completed successfully!"
      echo '========================================='
      script {
        // GitLab ìƒíƒœ ë¦¬í¬íŠ¸(í”ŒëŸ¬ê·¸ì¸ ìˆì„ ë•Œë§Œ; ì—†ì–´ë„ ë¬´ì‹œë˜ê²Œ try)
        try { updateGitlabCommitStatus name: 'build', state: 'success' } catch (e) { echo "gitlab status skip: ${e}" }
        sh """
          echo "ğŸ‰ Deployment Info"
          echo "  Image: ${DOCKER_REGISTRY}/${DOCKER_IMAGE}:${DOCKER_TAG}"
          echo "  Build: #${BUILD_NUMBER}"
          echo "  Time : $(date)"
          docker-compose -f ${COMPOSE_FILE} ps || true
        """
      }
    }
    failure {
      echo '========================================='
      echo "âŒ CI/CD Pipeline failed!"
      echo '========================================='
      script {
        try { updateGitlabCommitStatus name: 'build', state: 'failed' } catch (e) { echo "gitlab status skip: ${e}" }
        sh 'docker-compose -f ${COMPOSE_FILE} logs --tail=100 || true'
      }
    }
    always {
      echo 'ğŸ” Finalizing...'
      sh 'rm -f ${BACKEND_DIR}/.env || true'
    }
  }
}
