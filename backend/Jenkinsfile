pipeline {
  agent any

  // ‚ñ∂ ÏõπÌõÖÏúºÎ°ú Ï†ÑÎã¨Î∞õÏùÑ Î∏åÎûúÏπò
  parameters {
    string(name: 'BRANCH', defaultValue: 'infra', description: 'ÎπåÎìúÌï† Git Î∏åÎûúÏπò')
  }

  environment {
    // ====== Í∏∞Î≥∏ ÏÑ§Ï†ï ======
    GIT_URL         = 'https://lab.ssafy.com/s13-final/S13P31A708.git' // GitLab Repo
    GIT_CREDENTIALS = 'gitlab-https-pat'                               // Jenkins Credential ID

    BACKEND_DIR     = 'backend'
    COMPOSE_FILE    = "${env.BACKEND_DIR}/docker-compose.yml"
    DOCKER_IMAGE    = 'dito-backend:latest'                            // Í≥†Ï†ï ÌÉúÍ∑∏ (Ïù¥ÎØ∏ÏßÄ Ïû¨ÏÇ¨Ïö©)
  }

  options {
    buildDiscarder(logRotator(numToKeepStr: '10'))
    timeout(time: 30, unit: 'MINUTES')
    disableConcurrentBuilds()
    timestamps()
  }

  stages {

    stage('üìã Prepare') {
      steps {
        script {
          echo '========================================='
          echo "üöÄ Starting CI/CD Pipeline"
          echo "Build #${env.BUILD_NUMBER}"
          echo "Branch param: ${params.BRANCH}"
          echo '========================================='
        }
        deleteDir()
      }
    }

    stage('üîç Checkout') {
      steps {
        echo "üì¶ Checking out source from ${params.BRANCH}..."
        git branch: params.BRANCH, url: env.GIT_URL, credentialsId: env.GIT_CREDENTIALS
        sh '''
          echo "Current directory: $(pwd)"
          echo "Git branch: $(git rev-parse --abbrev-ref HEAD)"
          echo "Git commit: $(git rev-parse --short HEAD)"
        '''
      }
    }

    stage('üîê Environment Setup') {
      steps {
        echo 'üîê Injecting secret env file...'
        script {
          withCredentials([file(credentialsId: 'dito-backend-env', variable: 'ENV_FILE')]) {
            sh '''
              cp "$ENV_FILE" "$BACKEND_DIR/.env"
              chmod 600 "$BACKEND_DIR/.env"
            '''
          }
        }
      }
    }

    stage('üèóÔ∏è Build JAR') {
      steps {
        dir("${BACKEND_DIR}/Dito") {  // gradlewÍ∞Ä ÏûàÎäî Í≤ΩÎ°úÎ°ú Ïù¥Îèô
          sh '''
            echo "üß± Building jar file..."
            chmod +x gradlew
            ./gradlew clean build -x test
          '''
        }
      }
    }

    stage('üöÄ Deploy (Local Docker)') {
      steps {
        dir("${BACKEND_DIR}") {
          sh '''#!/bin/bash -e
            echo "üßπ Stopping existing containers..."
            docker-compose -f docker-compose.yml down || true

            echo "üîé Built artifacts:"
            ls -al Dito/build/libs || true

            echo "üì¶ Picking Spring Boot fat jar (exclude *-plain.jar)..."
            # -plain.jar Ï†úÏô∏ÌïòÍ≥† Ï≤´ Î≤àÏß∏ Ìï≠Î™©Îßå ÏÑ†ÌÉù (Î∞±Ïä¨ÎûòÏãú Ïù¥Ïä§ÏºÄÏù¥ÌîÑ ÏóÜÏù¥ Î¶¨ÌÑ∞Îü¥ Îß§Ïπ≠)
            JAR_PATH=$(ls Dito/build/libs/*-SNAPSHOT.jar | grep -v -- "-plain.jar" | head -n1)

            if [ -z "$JAR_PATH" ] || [ ! -f "$JAR_PATH" ]; then
              echo "‚ùå Boot JAR not found in Dito/build/libs (fat jar)"
              exit 1
            fi

            echo "‚û°Ô∏è  Copying $JAR_PATH -> app.jar"
            cp "$JAR_PATH" ./app.jar
            chmod 644 ./app.jar

            echo "üöÄ Docker Compose build & up..."
            docker compose -f docker-compose.yml up -d --build

            echo "‚úÖ Current services:"
            docker compose -f docker-compose.yml ps
          '''
        }
      }
    }



    stage('üè• Health Check') {
      steps {
        script {
          retry(5) {
            sleep 10
            sh 'curl -fsS http://localhost:8080/actuator/health && echo "‚úÖ Application is healthy"'
          }
        }
      }
    }

    stage('üßπ Cleanup') {
      steps {
        sh '''
          echo "üßπ Cleaning up unused images..."
          docker image prune -f || true
        '''
      }
    }
  }

  post {
    success {
      echo '========================================='
      echo "‚úÖ CI/CD Pipeline completed successfully!"
      echo '========================================='
      sh '''
        echo "üéâ Deployment Info"
        echo "  Image: ${DOCKER_IMAGE}"
        echo "  Build: #${BUILD_NUMBER}"
        echo "  Time : $(date)"
      '''
    }
    failure {
      echo '========================================='
      echo "‚ùå CI/CD Pipeline failed!"
      echo '========================================='
      sh "docker compose -f ${COMPOSE_FILE} logs --tail=100 || true"
    }
    always {
      echo 'üîç Finalizing...'
      sh "rm -f ${BACKEND_DIR}/.env || true"
    }
  }
}
