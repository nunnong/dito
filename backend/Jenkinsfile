pipeline {
  agent any

  // â–¶ ì›¹í›…ìœ¼ë¡œ ì „ë‹¬ë°›ì„ ë¸Œëœì¹˜
  parameters {
    string(name: 'BRANCH', defaultValue: 'infra', description: 'ë¹Œë“œí•  Git ë¸Œëœì¹˜')
  }

  environment {
    // ====== ê¸°ë³¸ ì„¤ì • ======
    GIT_URL         = 'https://lab.ssafy.com/s13-final/S13P31A708.git' // GitLab Repo
    GIT_CREDENTIALS = 'gitlab-https-pat'                               // Jenkins Credential ID

    BACKEND_DIR     = 'backend'
    COMPOSE_FILE    = "${env.BACKEND_DIR}/docker-compose.yml"
    DOCKER_IMAGE    = 'dito-backend:latest'                            // ê³ ì • íƒœê·¸ (ì´ë¯¸ì§€ ì¬ì‚¬ìš©)
  }

  options {
    buildDiscarder(logRotator(numToKeepStr: '10'))
    timeout(time: 30, unit: 'MINUTES')
    disableConcurrentBuilds()
    timestamps()
  }

  stages {

    stage('ğŸ“‹ Prepare') {
      steps {
        script {
          echo '========================================='
          echo "ğŸš€ Starting CI/CD Pipeline"
          echo "Build #${env.BUILD_NUMBER}"
          echo "Branch param: ${params.BRANCH}"
          echo '========================================='
        }
        deleteDir()
      }
    }

    stage('ğŸ” Checkout') {
      steps {
        echo "ğŸ“¦ Checking out source from ${params.BRANCH}..."
        git branch: params.BRANCH, url: env.GIT_URL, credentialsId: env.GIT_CREDENTIALS
        sh '''
          echo "Current directory: $(pwd)"
          echo "Git branch: $(git rev-parse --abbrev-ref HEAD)"
          echo "Git commit: $(git rev-parse --short HEAD)"
        '''
      }
    }

    stage('ğŸ” Environment Setup') {
      steps {
        echo 'ğŸ” Injecting secret env file...'
        script {
          withCredentials([file(credentialsId: 'dito-backend-env', variable: 'ENV_FILE')]) {
            sh '''
              cp "$ENV_FILE" "$BACKEND_DIR/.env"
              chmod 600 "$BACKEND_DIR/.env"
            '''
          }
        }
      }
    }

    stage('ğŸ—ï¸ Build JAR') {
      steps {
        dir("${BACKEND_DIR}") {
          sh '''
            echo "ğŸ§± Building jar file..."
            ./gradlew clean build -x test
          '''
        }
      }
    }

    stage('ğŸš€ Deploy (Local Docker)') {
      steps {
        dir("${BACKEND_DIR}") {
          sh '''
            echo "ğŸ§¹ Stopping existing containers..."
            docker-compose -f docker-compose.yml down || true

            echo "ğŸ“¦ Updating jar file..."
            cp build/libs/*.jar app.jar

            echo "ğŸš€ Starting updated container..."
            docker-compose -f docker-compose.yml up -d --build

            echo "âœ… Deployment complete!"
            docker-compose ps
          '''
        }
      }
    }

    stage('ğŸ¥ Health Check') {
      steps {
        script {
          retry(5) {
            sleep 10
            sh 'curl -fsS http://localhost:8080/actuator/health && echo "âœ… Application is healthy"'
          }
        }
      }
    }

    stage('ğŸ§¹ Cleanup') {
      steps {
        sh '''
          echo "ğŸ§¹ Cleaning up unused images..."
          docker image prune -f || true
        '''
      }
    }
  }

  post {
    success {
      echo '========================================='
      echo "âœ… CI/CD Pipeline completed successfully!"
      echo '========================================='
      sh '''
        echo "ğŸ‰ Deployment Info"
        echo "  Image: ${DOCKER_IMAGE}"
        echo "  Build: #${BUILD_NUMBER}"
        echo "  Time : $(date)"
      '''
    }
    failure {
      echo '========================================='
      echo "âŒ CI/CD Pipeline failed!"
      echo '========================================='
      sh "docker-compose -f ${COMPOSE_FILE} logs --tail=100 || true"
    }
    always {
      echo 'ğŸ” Finalizing...'
      sh "rm -f ${BACKEND_DIR}/.env || true"
    }
  }
}
